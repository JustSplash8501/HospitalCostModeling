---
title: "Medical Insurance Cost Prediction: Data Exploration"
author: "Reese Wilson"
date: today
format: 
  pdf:
    toc: true
  html:
    toc: true
    theme: cosmo
description: |
  Analysis and modeling of insurance charges using demographic and health features.
  Includes feature engineering, Random Forest regression with hyperparameter tuning via Optuna,
  and interpretability with SHAP.
keywords: [data science, machine learning, regression, Random Forest, Optuna, SHAP]
repository: https://github.com/JustSplash8501/hospital-cost-modeling
execute:
  warning: false
  message: false
  echo: true
---

# Executive Summary

This analysis develops predictive models for medical insurance costs using patient demographic and health data. We compare two modeling approaches: Multiple Linear Regression and Random Forest Regression. The Random Forest model significantly outperformed linear regression, achieving a test MAE of $2,560 compared to $4,237, demonstrating the importance of capturing non-linear relationships in insurance cost prediction. Key findings reveal that smoking status, age, and BMI are the most influential factors in determining medical insurance costs.

# Introduction

## Background

Medical insurance costs in the United States vary substantially based on individual characteristics and health factors. Understanding the drivers of these costs is crucial for insurance companies in premium pricing, risk assessment, and for individuals in making informed healthcare decisions. This analysis examines how demographic factors (age, sex, region) and health-related variables (BMI, smoking status, number of children) influence medical insurance charges.

## Research Questions

1. What are the primary factors driving medical insurance costs?
2. Can we accurately predict insurance charges based on patient characteristics?
3. How do non-linear relationships affect model performance in cost prediction?
4. What is the magnitude of impact for each predictor variable?

## Dataset Description

The dataset contains medical insurance information for 1,338 individuals with the following variables:

- **Age**: Patient age in years
- **Sex**: Male or female
- **BMI**: Body Mass Index, a measure of body fat based on height and weight
- **Children**: Number of dependents covered by insurance
- **Smoker**: Whether the individual smokes (yes/no)
- **Region**: Geographic region in the US (northeast, northwest, southeast, southwest)
- **Charges**: Medical insurance costs billed by insurance (target variable)

# Data Import and Exploration

```{python}
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os

if os.name == "posix":
    path = "/Users/raw/Desktop/gitProjects/HospitalCostModeling/data/insurance.csv"
else:
    path = r"A:\VSCodeProjects\MLA Projects\HospitalCostModeling\data\insurance.csv"

healthdata = pd.read_csv(path)
healthdata.head()
```

## Descriptive Statistics

```{python}
# Summary statistics
print("Dataset Shape:", healthdata.shape)
print("\nSummary Statistics:")
print(healthdata.describe().T)

print("\nCategorical Variables:")
print(healthdata[["sex", "smoker", "region"]].describe().T)

print("\nMissing Values:")
print(healthdata.isnull().sum())
```

```{python}

cat_cols = ["sex", "smoker", "region", "children"]
num_cols = ["age", "bmi"]

for col in cat_cols:
    print(
        pd.DataFrame(
            {
                "Count": healthdata[col].value_counts(),
                "Ratio": 100 * healthdata[col].value_counts() / len(healthdata),
            }
        ).to_markdown(numalign="center", stralign="center")
    )
    print("\n")
```

## Exploratory Data Analysis

### Distribution of Insurance Charges

```{python}
fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Histogram
axes[0].hist(healthdata['charges'], bins=50, edgecolor='black', alpha=0.7)
axes[0].set_xlabel('Insurance Charges ($)')
axes[0].set_ylabel('Frequency')
axes[0].set_title('Distribution of Insurance Charges')
axes[0].grid(axis='y', alpha=0.3)

# Box plot
axes[1].boxplot(healthdata['charges'])
axes[1].set_ylabel('Insurance Charges ($)')
axes[1].set_title('Box Plot of Insurance Charges')
axes[1].grid(axis='y', alpha=0.3)

plt.tight_layout()
plt.show()

print(f"Mean Insurance Cost: ${healthdata['charges'].mean():,.2f}")
print(f"Median Insurance Cost: ${healthdata['charges'].median():,.2f}")
print(f"Std Dev: ${healthdata['charges'].std():,.2f}")
```

The distribution of insurance charges is right-skewed, indicating that while most individuals have moderate costs, some have exceptionally high charges. This suggests the presence of distinct subgroups in the data, likely driven by health risk factors.

### Relationship Between Key Variables and Charges

```{python}
fig, axes = plt.subplots(2, 2, figsize=(14, 10))

# Age vs Charges
axes[0, 0].scatter(healthdata['age'], healthdata['charges'], alpha=0.5)
axes[0, 0].set_xlabel('Age')
axes[0, 0].set_ylabel('Insurance Charges ($)')
axes[0, 0].set_title('Age vs Insurance Charges')
axes[0, 0].grid(alpha=0.3)

# BMI vs Charges
axes[0, 1].scatter(healthdata['bmi'], healthdata['charges'], alpha=0.5)
axes[0, 1].set_xlabel('BMI')
axes[0, 1].set_ylabel('Insurance Charges ($)')
axes[0, 1].set_title('BMI vs Insurance Charges')
axes[0, 1].grid(alpha=0.3)

# Smoker vs Charges
smoker_data = healthdata.groupby('smoker')['charges'].apply(list)
axes[1, 0].boxplot([smoker_data['no'], smoker_data['yes']], labels=['Non-Smoker', 'Smoker'])
axes[1, 0].set_ylabel('Insurance Charges ($)')
axes[1, 0].set_title('Smoking Status vs Insurance Charges')
axes[1, 0].grid(axis='y', alpha=0.3)

# Children vs Charges
children_data = healthdata.groupby('children')['charges'].mean()
axes[1, 1].bar(children_data.index, children_data.values)
axes[1, 1].set_xlabel('Number of Children')
axes[1, 1].set_ylabel('Average Insurance Charges ($)')
axes[1, 1].set_title('Number of Children vs Average Insurance Charges')
axes[1, 1].grid(axis='y', alpha=0.3)

plt.tight_layout()
plt.show()
```

### Age and BMI + Smoker status Analysis

```{python}
import matplotlib.pyplot as plt
from matplotlib.patches import Patch

# Ensure smoker column is lowercase strings (handles "Yes"/"No" etc.)
smoker_col = healthdata["smoker"].str.lower()
colors = [
    "#2ecc71" if s in ["no", "non-smoker", "0"] else "#e74c3c" for s in smoker_col
]

fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Age vs charges colored by smoker status
axes[0].scatter(
    healthdata["age"],
    healthdata["charges"],
    c=colors,
    alpha=0.6,
    s=50,
    edgecolors="black",
    linewidth=0.5,
)
axes[0].set_xlabel("Age", fontsize=11, fontweight="bold")
axes[0].set_ylabel("Charges ($)", fontsize=11, fontweight="bold")
axes[0].set_title(
    "Age vs Charges (colored by Smoker Status)", fontsize=12, fontweight="bold"
)
axes[0].grid(True, alpha=0.3)

legend_elements = [
    Patch(facecolor="#2ecc71", label="Non-Smoker"),
    Patch(facecolor="#e74c3c", label="Smoker"),
]
axes[0].legend(
    handles=legend_elements, loc="upper left", frameon=True, fancybox=True, shadow=True
)

# Age vs BMI colored by smoker status
axes[1].scatter(
    healthdata["bmi"],
    healthdata["charges"],
    c=colors,
    alpha=0.6,
    s=50,
    edgecolors="black",
    linewidth=0.5,
)
axes[1].set_xlabel("BMI", fontsize=11, fontweight="bold")
axes[1].set_ylabel("Charges ($)", fontsize=11, fontweight="bold")
axes[1].set_title(
    "BMI vs Charges (colored by Smoker Status)", fontsize=12, fontweight="bold"
)
axes[1].grid(True, alpha=0.3)
axes[1].legend(
    handles=legend_elements, loc="upper left", frameon=True, fancybox=True, shadow=True
)

plt.tight_layout()
plt.show()
```


**Key Findings:**

- Smokers incur dramatically higher insurance costs, with average charges approximately 3x higher than non-smokers
- Age shows a positive relationship with charges, but with notable clustering patterns as a result of smoking and BMI
- BMI demonstrates a non-linear relationship, particularly for smokers
- Regional differences appear relatively modest
- The number of children shows a weak positive association with charges
